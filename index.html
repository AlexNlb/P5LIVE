<!DOCTYPE html>
<html>
<head>
	<title>P5LIVE</title>
	<meta charset="utf-8">
	<meta name="description" content="P5LIVE - p5.js live-coding vj environment!">
	<meta name="author" content="teddavis.org">

	<link rel="icon" type="image/png" href="includes/icons/icon.png">
	<link rel="apple-touch-icon" href="includes/icons/apple-touch-icon.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="P5LIVE">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

	 <!-- Facebook -->
    <meta property="og:url" content="https://teddavis.org/p5live">
    <meta property="og:type" content="website">
    <meta property="og:title" content="P5LIVE">
    <meta property="og:description" content="p5.js live-coding vj environment!">
    <meta property="og:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="P5LIVE">
    <meta name="twitter:creator" content="teddavis.org">
    <meta name="twitter:title" content="P5LIVE">
    <meta name="twitter:description" content="p5.js live-coding vj environment!">
    <meta name="twitter:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

    <link rel="stylesheet" type="text/css" media="screen" href="includes/style.css">

	<script src="includes/js/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<script src="includes/js/src-min-noconflict/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
	<script src="includes/js/Sortable.js"></script>
	<script src="includes/js/beautify.js"></script>
	<script src="includes/js/jscolor.js"></script>
</head>
<body>
	<div id="p5-editor">
		<pre id="p5-code" autofocus class="p5-ta"></pre>
		<textarea id="p5-console" class="p5-ta" disabled></textarea>
	</div>

	<iframe id="p5-frame" sandbox="allow-same-origin allow-scripts" src="p5live_sketch.html" onLoad="injectJS()";></iframe>
	<div id="p5-frame-cover"></div>

	<div id="menu">
		<div id="menu-bg"></div>
		<div id="menu-switch" onclick="menuToggle();">X</div>
		<div id="menu-sections">
		
			<div class="menu-section">
				<div class="menu-header">P5LIVE</div>
				<div class="menu-sketches-buttons">
					<button class="menu-button" onclick="loadAbout();" title="The more you know...">ABOUT</button>
					<button class="menu-button" onclick="resetP5();" title="Totally reset P5Live">RESET</button>
					<button class="menu-button" onclick="loadDemo();" title="Load P5LIVE demos">DEMOS</button>
				</div>
			</div>
		
			<div class="menu-section">
				<div id="menu-sketches-header" class="menu-header">SKETCHES</div>
				<div class="menu-sketches-buttons">
					<button class="menu-button" onclick="loadDefault();" title="CTRL + N » Create new sketch">NEW</button>
					<button class="menu-button" onclick="document.getElementById('file-input').click();" title="Import sketch(es)">IMPORT</button>
					<input id="file-input" type="file" name="name" multiple style="display: none;" onchange="sketchesImport(this.files);" />
					<button class="menu-button" onclick="sketchesExport();" title="Export all sketches">EXPORT</button>
					<button class="menu-button" onclick="sketchesClear();" title="Clear entire sketches list">CLEAR</button>
				</div>

				<div id="menu-sketches-new"></div>
				<div id="menu-sketches-holder" >
					<div id="menu-sketches"></div>
				</div>
			</div>
			
			<div class="menu-section">
				<div id="menu-settings-header" class="menu-header">SETTINGS</div>
				<div id="menu-settings" class="menu-contents">
					<div style="cursor:help;" title="CTRL + A » Compiles code on each keypress">
						Auto Compile: 
						<input type="checkbox" id="settings-autocompile" name="settings-autocompile" value="settings-autocompile" onchange="autoCompileToggle();">
					</div>
					<div style="cursor:help;" title="CTRL + F » Toggle fullscreen mode">
						Fullscreen: 
						<input type="checkbox" id="settings-fullscreen" name="settings-fullscreen" value="settings-fullscreen" onchange="fullscreenToggle();">
					</div>
					<div style="cursor:help;" title="Only render if window is active (focused)">
						Eco Render:
						<input type="checkbox" id="settings-ecorender" name="settings-ecorender" value="settings-ecorender" onchange="ecoRenderToggle();">
					</div>
					<div style="cursor:help;" title="CTRL + C » Display mouse cursor when editor is hidden">
						Cursor: 
						<input type="checkbox" id="settings-canvascursor" name="settings-canvascursor" value="settings-canvascursor" onchange="cursorToggle();">
					</div>
					<div style="cursor:help;" title="*** If unchecked, can only toggle menu via shortcut, CTRL + M">
						Menu Tab: 
						<input type="checkbox" id="settings-menutab" name="settings-menutab" value="settings-menutab" onchange="menutabToggle();">
					</div>
					<div style="display:none;cursor:help;" title="Add extra libs to your sketches, will be added on each compile">
						<span>Libs:</span> 
						<input type="text" id="settings-libs" name="settings-libs" placeholder="CSV, of, libs">
					</div>
					<div  style="cursor:help;" title="CTRL + +/- » Adjust font-size">
						Font Size: <input type="" name="menu-settings-fontsize" id="menu-settings-fontsize" value="15" onkeyup="fontSizeAdjust(this.value);"> pt
					</div>
					<div  style="cursor:help;" title="Set theme (ignored in Auto Compile mode)">
						Theme: 
						<select id="menu-settings-theme" onchange="setTheme(this.selectedIndex);">
							<option value="ace/theme/dawn">Dawn</option>
							<option value="ace/theme/kuroir">Kuroir</option>
							<option value="ace/theme/ambiance">Ambiance</option>
							<option value="ace/theme/cobalt">Cobalt</option>
							<option value="ace/theme/mono_industrial">Mono Industrial</option>
							<option value="ace/theme/pastel_on_dark">Pastel on dark</option>
							<option value="ace/theme/solarized_dark">Solarized Dark</option>
							<option value="ace/theme/twilight">Twilight</option>
						</select>
					</div>
					<div  style="cursor:help;" title="Set code background color">
					Background: <input id="menu-settings-bg" class="jscolor {width:101, padding:0, shadow:false,
    borderWidth:0, backgroundColor:'transparent', insetColor:'#000'}" onchange="setBG(this.jscolor);">
					</div>
				</div>
			</div>

		</div>
	</div>
	<textarea style="display:none;" id="p5-template">
function setup() {
	createCanvas(windowWidth, windowHeight);
	
}

function draw() {
	
}
	</textarea>
	<textarea style="display:none;" id="p5-custom">
// readjust if window-resized
function windowResized() {
	resizeCanvas(windowWidth, windowHeight);
}

// custom ease function
function ease(iVal, oVal, eVal){
	var targetX = iVal;
	var dx = targetX - oVal; 
	return oVal += dx * eVal;
}

// processing compatibility
function println(msg){
	print(msg);
}
	</textarea>
	<textarea style="display:none;" id="p5live-about">
/*
P5LIVE v 1.0.1
cc teddavis.org 2019
p5.js live-coding vj environment!


SHORTCUTS
-------------------------------
CTRL + N » new sketch
CTRL + ENTER » compile
CTRL + A » autocompile toggle
CTRL + E » editor toggle
CTRL + F » fullscreen toggle
CTRL + M » menu toggle
CTRL + C » cursor toggle
CTRL + T » tidy code
CTRL + - » decrease fontsize
CTRL + + » increase fontsize
CTRL + O » open sketch prompt
CTRL + 1,2,3...0 » load first 10 sketches


GETTING STARTED
-------------------------------
Create, New Sketch + start coding! 
Run, CTRL + ENTER to compile new code, or activate auto-compile.
Save, Type name into 'Save Sketch As...' and hit Enter.
Save As, same as above while editing existing sketch.

- P5LIVE Buttons:
ABOUT, what you're reading now.
RESET, re-initialize P5LIVE.
DEMOS, load presets to learn from.

- SKETCHES Buttons:
NEW, new sketch.
IMPORT, select JSON files from export (all or single sketches).
EXPORT, download entire sketches list as JSON for import.
CLEAR, erase entire sketches list.

- SKETCHES List:
Load, click on sketch name.
Rename, click 'id' and type new name.
Export, click '↓' to download sketch as JSON file.
Remove, click 'x' and confirm removal.
Sort, click and drag to desired order.

- SETTINGS:
Auto Compile, live-coding mode, refreshes on keyup.
Fullscreen, toggle fullScreen(), ideal for VJing
Eco Render, toggle loop()/noLoop() when browser window is out of focus.
Cursor, toggle visible cursor when hiding editor (ctrl + e).
Menu Tab, toggles menu tab. Hide if VJ'ing (don't forget CTRL + M for menu).
Font Size, adjust size of editor text.
Theme, set code syntax coloring (ignored in Auto Compile mode).
Background, set color behind each line of code.

- SNIPPETS:
Add them to 'includes/demos/P5L_snippets.json'.
Load them via shortcut, CTRL + SHIFT + #
ie. CTRL + SHIFT + 1, for audio-reactive visualizations.

- Want custom assets (fonts/images)? 
Clone/download from github and host locally using MAMP server. 
Drop files into folder and link relatively, ('data/fish.png')

- Note that all settings/sketches are stored in localStorage only.
Clearing browser cache/storage = will likely erase all sketches. 
Be sure to export often.

- Fan going nuts? Set pixelDensity(1); within setup() if on a retina display.


FUNCTIONS
-------------------------------
- `ease(inVal, outVariable, easeVal)` // smooth values
- `frameCount` is continous per loaded sketch.


FUTURE
-------------------------------
- audio variables (easedAudio, fft bands)
- etherpad-like collaborative editing (firepad? codepile?)
- custom code/functions header
- api (get for sketch + settings)
- mobile optimization
- additional js libs (via settings)
- additional assets
- export image [video?]
- tree structure for sketches
- export as HTML for website usage
- autocomplete w/ p5.js functions


THANKS
-------------------------------
p5.js » https://p5js.org (magic)
ace editor » https://ace.c9.io (editor)
tinkerpad » https://github.com/tomhodgins/tinkerpad (localstorage idea)
Roboto Mono » https://github.com/google/roboto (font)


INSPIRATION
-------------------------------
- cyril » https://github.com/cyrilcode/cyril
- Hydra » https://github.com/ojack/hydra


SOURCE
-------------------------------
github » https://github.com/ffd8/p5live


*/

function setup() {
	createCanvas(windowWidth, windowHeight);
	noStroke();
	mouseX = width/2;
	mouseY = height/2;
	pixelDensity(1);
}

function draw() {
	background(0);
	tri(0, 0, mouseX, mouseY, 0, height, 100);
	tri(0, 0, mouseX, mouseY, width, 0, 200);
	tri(width, height, mouseX, mouseY, 0, height, 0);
	tri(width, height, mouseX, mouseY, width, 0, 255);
}

function tri(x1, y1, x2, y2, x3, y3, fc){
	var v = 0.002;
	fill(abs(sin(fc+(frameCount*v)))*255);
	beginShape();
	vertex(x1, y1);
	vertex(x2, y2);
	vertex(x3, y3);
	endShape();
}
	</textarea>
	<script type="text/javascript">
		'use strict'

		/*
			TODO
			- make console click-through
			- custom assets guide
			- 
		*/



		/* INIT THINGS */

		// init localStorage
		var reset = false;

		if(reset){localStorage.clear();}

		function resetP5(){
			var doubleCheck = confirm("Completely reset P5LIVE?");
			if(doubleCheck){
				localStorage.clear();
				location.reload();
			}
		}

		var initSettings = {
			"welcome":true,
			"fontSize":15, 
			"autoCompile":true, 
			"ecoRender": true,
			"canvasCursor": true,
			"fullscreenMode":false,
			"fileName": '',
			"menuMode": true,
			"menutab":true,
			"debugMode": false,
			"sketches": [],
			"sketchesSortable": '',
			"scripts": ["includes/p5/addons/p5.dom.min.js", "includes/p5/p5.min.js", "includes/p5/addons/p5.sound.min.js"],
			"theme": "ace/theme/twilight",
			"themeBG": "052544",
		}
	
		// init vars
		var p5editor = document.getElementById('p5-editor'),
		p5code = document.getElementById('p5-code'),
		p5console = document.getElementById('p5-console'),
		p5custom = document.getElementById('p5-custom'),
		p5template = document.getElementById('p5-template').value,
		p5frame = document.getElementById('p5-frame'),
		p5frameCover = document.getElementById('p5-frame-cover'),
		p5f = p5frame.contentWindow,
		p5liveabout = document.getElementById('p5live-about').value,
		p5script = document.getElementById("holdscript"),
		menuSketches = document.getElementById('menu-sketches'),
		menuSettings = document.getElementById('menu-settings'),
		menuBG = document.getElementById('menu-bg'),
		settingsFontsize = document.getElementById('menu-settings-fontsize'),
		settingsAutoMode = document.getElementById('settings-autocompile'),
		settingsFullscreen = document.getElementById('settings-fullscreen'),
		settingsEcoMode = document.getElementById('settings-ecorender'),
		settingsCanvasCursor = document.getElementById('settings-canvascursor'),
		settingsMenutab = document.getElementById('settings-menutab'),
		menuNewSketch = document.getElementById('menu-sketch-new'),
		menuPanel = document.getElementById('menu'),
		menuSwitch = document.getElementById('menu-switch'),
		menuTheme = document.getElementById("menu-settings-theme"),
		settingsBG = document.getElementById("menu-settings-bg"),
		settings = getSettings(),
		validCode = true, 
		sketchLoaded = false,
		pLen = 0, 
		paused = false,
		markerID = [],
		errorTimer,
		snippets, 
		fc = 0;

		// force off
		settings.debugMode = false;
		
		// init editor 
		var Range = ace.require('ace/range').Range;
		var editor = ace.edit("p5-code");
		editor.setTheme(settings.theme);
		editor.session.setMode("ace/mode/javascript");
		editor.setOptions({
			showPrintMargin: false,
			animatedScroll: false,
			displayIndentGuides: false,
			useWorker: true,
			showLineNumbers: false,
			showGutter: false,
			tabSize: 4, useSoftTabs: false,
		});
		
		p5editor.style.visibility = "visible";



		/* FANCY EDITOR FUNCTIONS */

		// check for errors
		editor.getSession().on("changeAnnotation", function(){
			var annot = editor.getSession().getAnnotations();
			validCode = true;
			for(var i=0; i < annot.length; i++){
				if(annot[i].type === "error"){
					addMarker(annot[i].row);
					validCode = false;
				}
			}
			if(validCode){
				removeMarkers();
			}
		});

		function addMarker(n){
			var elementPos = markerID.map(function(x) {return x.line; }).indexOf(n);
			if (elementPos === -1) {
				markerID.push({"line":n, "id":editor.session.addMarker(new Range(n, 0, n, 7000), "myMarker", "fullLine")});
			}
		}

		function removeMarkers(){
			for(var i=0; i < markerID.length; i++){
				editor.session.removeMarker(markerID[i].id);
			}
			markerID = [];
		}

		// set editor BG
		editor.renderer.on("afterRender", function(){
			adjustLines();
		});

		function adjustLines(){
			var pcode = document.getElementsByClassName("ace_line");
			for(var i=0; i < pcode.length; i++){
				var pitem = pcode[i];
				var pcontents = pitem.innerHTML;
				pitem.innerHTML = '<span class="ace_line_bg" style="background:#'+settings.themeBG+'">' + pcontents + '</span>';
			}
		}


		/* CMD-KEYS (remove key conflicts) */
		editor.commands.removeCommands(["gotoright","movelinesup", "movelinesdown", "gotolinestart", "splitline", "gotolineend", "golineup", "jumptomatching", "golinedown", "transposeletters"]);

		 // replace backspace w/o ctrl + h
		 editor.commands.addCommand({
			name: "backspace",
			bindKey: { win: "Shift-Backspace|Backspace", mac: "Ctrl-Backspace|Shift-Backspace|Backspace" },
			exec: function(e) { e.remove("left") },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor"
		 });

		 // replace gotoright w/o ctrl + f
		 editor.commands.addCommand({
			name: "gotoright",
			bindKey: { win: "Right", mac: "Right" },
			exec: function(e,t) { e.navigateRight(t.times) },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor",
			readOnly:!0
		 });

		 // replace golineup w/o ctrl + p
		 editor.commands.addCommand({
			name: "golineup",
			bindKey: { win: "Up", mac: "Up" },
			exec: function(e,t) { e.navigateUp(t.times) },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor",
			readOnly:!0
		 });

		 // replace golinedown w/o ctrl + n
		 editor.commands.addCommand({
			name: "golinedown",
			bindKey: { win: "Down", mac: "Down" },
			exec: function(e,t) { e.navigateDown(t.times) },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor",
			readOnly:!0
		 });

		 // beautify!
		 var beautifyOptions = {
			"indent_size": "1",
			"indent_char": "\t",
			"max_preserve_newlines": "5",
			"preserve_newlines": true,
			"keep_array_indentation": false,
			"break_chained_methods": false,
			"indent_scripts": "normal",
			"brace_style": "collapse",
			"space_before_conditional": false,
			"unescape_strings": false,
			"jslint_happy": false,
			"end_with_newline": false,
			"wrap_line_length": "0",
			"indent_inner_html": false,
			"comma_first": false,
			"e4x": false
		 }



		 /* DEBUG EDITOR COMMANDS + STORAGE */

		 // list ace editor commands
		 function listCommands(){
			var cmds = editor.commands.commands;
			var k = [];
			for (var cmd in cmds){
				k.push(cmd.name +" = "+ cmd.bindKey);
			}
			console.log(cmds);
		 }

		// check storageKeys    
		function getKeys(){
			var k = [];
			for (var key in localStorage){
				k.push(key);
			}
			console.log(k.join(", "));
		 }

		if(settings.debugMode){
			listCommands();
			getKeys();
		 }


		 /* p5 iframe communication */

		// mark error line
		window.document.addEventListener('myEvent', handleEvent, false)
		function handleEvent(e) {
			if(e.detail.lineNumber != undefined){
				var errorLine = parseInt(e.detail.lineNumber)-1;
				addMarker(errorLine);
			}else{
				removeMarkers()
			}
			// sketchloaded
			if(e.detail.status){
				p5f.frameCount = fc;
				p5f.background(0);
				fc = 0;
				sketchLoaded = true;
			}else{
				sketchLoaded = false;
			}
		}

		

		/* SETTINGS + SKETCHES */

		// init settings
		loadSettings();

		// get settings from localstorage
		function getSettings(){
			var tempSettings = initSettings;
			if(localStorage.hasOwnProperty('settings')){
				tempSettings = JSON.parse(localStorage.getItem('settings'));
			}
			return tempSettings;
		}

		// react to settings once gathered
		function loadSettings(){
			fontSizeUpdate();
			autoCompileUpdate();
			fullscreenUpdate();
			menuToggleUpdate();
			ecoRenderUpdate();
			cursorToggleUpdate();
			menutabToggleUpdate();
			loadTheme();
			loadBG();
			loadSnippets();
			if(settings.welcome){
				loadAbout();
				settings.welcome = false;
				updateSettings();
			}else{
				loadSketch(settings.fileName);
			}
		}

		// set settings to localstorage
		function updateSettings(){
			localStorage.setItem('settings', JSON.stringify(settings));
			if(settings.debugMode){console.log(getSettings());}
		}

		// set sketches list to localstorage
		function updateSketches(){
			updateSettings();
			updateMenu();
		}

		// load sketch
		function loadSketch(sketch){
			if(localStorage.hasOwnProperty(sketch)){
				settings.fileName = sketch;
				editor.setValue(localStorage[settings.fileName], 1);
				pLen = editor.getValue().length;
				updateMenu();
				updateSettings();
				setTimeout(function(){fc = 0;recompile();}, 100);
				editor.getSession().setUndoManager(new ace.UndoManager());
				editor.focus();
			}else{
				loadDefault();
			}
		}

		// rename sketch
		function renameSketch(sketch){
			var newName = prompt('Please enter a new name for "'+sketch+'":').replace(/["']/g, "");
			if(newName != ''){
				localStorage.setItem(newName, localStorage[sketch]);
				var index = settings.sketches.indexOf(sketch);
				if (index !== -1) {
					settings.sketches[index] = newName;
				}
				localStorage.removeItem(sketch);
				updateSketches();
				setTimeout(function(){ loadSketch(newName); }, 100);
			}
		}

		// remove sketch
		function removeSketch(sketch){
			var doubleCheck = confirm("Are you sure you want to delete: " +sketch+" ?");
			if(doubleCheck){
				localStorage.removeItem(sketch);
				var index = settings.sketches.indexOf(sketch);
				if (index !== -1) {
					settings.sketches.splice(index, 1);
				}
				if(sketch === settings.fileName){
					setTimeout(function(){ loadDefault(); }, 100);
				}
				updateSketches();
			}
		}

		// pause sketch on demand
		function pauseSketch(){
			if(sketchLoaded){
				paused = !paused;
				if(paused){
					p5f.noLoop();
				}else{
					p5f.loop();
				}
			}
		}


		/* IMPORT/EXPORT SKETCHES */

		// export single sketch to JSON
		function exportSketch(sketch){
			var jsonExport = {};
			jsonExport.sketches = [];
			jsonExport.sketches.push({"sketchName":sketch, "sketchCode":localStorage.getItem(sketch)});
			var dateStamp = (new Date()).toISOString().replace(/[^0-9]/g, "").slice(0, -3);
			p5f.saveJSON(jsonExport, 'P5L_'+sketch+'_'+dateStamp+'.json');
			if(settings.debugMode){console.log(jsonExport);}
		}

		// export all sketches to JSON
		function sketchesExport(){
			var jsonExport = {};
			jsonExport.sketches = [];
			for(var i=0; i < settings.sketches.length; i++){
				jsonExport.sketches.push({"sketchName":settings.sketches[i], "sketchCode":localStorage.getItem(settings.sketches[i])});
			}
			jsonExport.settings = settings;
			var dateStamp = (new Date()).toISOString().replace(/[^0-9]/g, "").slice(0, -3);
			p5f.saveJSON(jsonExport, 'P5L_sketches_'+dateStamp+'.json');
			if(settings.debugMode){console.log(jsonExport);}
		}

		// import sketches from JSON
		function sketchesImport(data){
			for(var i=0; i < data.length; i++){
				var reader = new FileReader();
				reader.onload = function(data) {
					var jsonObj = JSON.parse(event.target.result);
					parseSketches(jsonObj);
				}
				reader.readAsText(data[i]);
			}
		}

		// load demos
		function loadDemo(){
			var doubleCheck = confirm("Add demos to sketches list?");
			if(doubleCheck){
				var demosPath = "includes/demos/P5L_demos.json";
				var request = new XMLHttpRequest();
				request.open("GET", demosPath, false);
				request.send(null)
				var jsonObj = JSON.parse(request.responseText);
				parseSketches(jsonObj);
			}
		}

		function parseSketches(jsonObj){
			var jsonSketches = jsonObj.sketches.reverse();
			for(var i=0; i < jsonSketches.length; i++){
				var sketchName = jsonSketches[i].sketchName;
				var sketchCode = jsonSketches[i].sketchCode;
				localStorage.setItem(sketchName, sketchCode);
				if (settings.sketches.indexOf(sketchName) === -1) {
					settings.sketches.unshift(sketchName);
				}
				if(sketchName == settings.fileName){
					loadSketch(sketchName);
				}
			}
			updateSketches();
		}

		// clear all sketches
		function sketchesClear(){
			var doubleCheck = confirm("Clear (remove) ALL skeches?");
			if(doubleCheck){
				for(var i=0; i < settings.sketches.length; i++){
					localStorage.removeItem(settings.sketches[i]);
				}
				localStorage.removeItem("sketches");
				settings.sketches = [];
				updateSketches();
			}
		}



		/* LIST SKETCHES IN MENU */

		function updateMenu(){
			var menuSketchesHTML = '';
			var selSelected = false;
			for(var i=0; i < settings.sketches.length; i++){
				var selClass = "";
				if(settings.sketches[i] == settings.fileName){
					selClass = 'sketch-selected';
					selSelected = true;
				}
				var marq = "";
				if(settings.sketches[i] != null && settings.sketches[i].length > 15){marq = "marq";}
				menuSketchesHTML += '<div class="menu-sketch-holder '+selClass+'" data-id="'+settings.sketches[i]+'"><div class="menu-sketch-nav"><a class="menu-sketch-button" onclick="renameSketch(\''+settings.sketches[i]+'\')" title="Rename Sketch">id</a><a class="menu-sketch-button" onclick="exportSketch(\''+settings.sketches[i]+'\')" title="Export Sketch">↓</a><a class="menu-sketch-button" onclick="removeSketch(\''+settings.sketches[i]+'\')" title="Remove Sketch">x</a></div><div class="menu-sketch '+marq+'" onclick="loadSketch(\''+settings.sketches[i]+'\')">'+settings.sketches[i]+'</div></div>';
			}
			var selClass = "";
			if(!selSelected){
				selClass = 'sketch-selected';
			}
			var menuSketchesNew = '<div class="menu-sketch-holder '+selClass+'"><input type="text" name="menu-sketch-new" id="menu-sketch-new" class="menu-sketch-holder" placeholder="Save Sketch As..." onfocus="document.getElementById(\'menu-sketch-new-save\').style.display=\'block\';" onblur="setTimeout(function(){document.getElementById(\'menu-sketch-new-save\').style.display=\'none\';}, 200)"><div id="menu-sketch-new-save" onclick="loadType();">SAVE</div></div>';
			menuSketches.innerHTML = menuSketchesHTML;
			document.getElementById('menu-sketches-new').innerHTML = menuSketchesNew;
			menuNewSketch = document.getElementById('menu-sketch-new');
		}

		// SortableJS for sketcheslist
		Sortable.create(menuSketches, {
			group: "sketchOrder",//"localStorage-example",
			store: {
				get: function (sortable) {
					var order = settings.sketches;
					return order;// ? order.split('|') : [];
				},
				set: function (sortable) {
					var order = sortable.toArray();
					settings.sketches = order;
					updateSettings();
				}
			}
		})



		/* EDITOR KEY-CMDS */

		// Editor Interactions
		p5code.onkeydown = function(event) {
			pLen = editor.getValue().length; // len of editor
			if(settings.debugMode){console.log(event);}
			if((event.key == '+' || event.key == '=' )&& event.ctrlKey){ // up arrow = bigger font
				fontSizeAdjust(parseFloat(settings.fontSize) + 0.25);
				event.preventDefault();
			}else if((event.key == '-') && event.ctrlKey){ // down arrow = smaller font
				fontSizeAdjust(parseFloat(settings.fontSize) - 0.25);
				event.preventDefault();
			}else if(event.keyCode == 65 && event.ctrlKey){ // a = auto compile
				autoCompileToggle();
				event.preventDefault();
			}else if(event.keyCode == 84 && event.ctrlKey){ // t = tidy code
				tidyCode();
				event.preventDefault();
			}
		}

		p5code.onkeyup = function(event) {
			localStorage[settings.fileName] = editor.getValue();
			clearTimeout(errorTimer);
			errorTimer = setTimeout(function(){checkErrors();}, 500);			
		};

		function checkErrors(){
			var annos = editor.getSession().getAnnotations();
			if(settings.debugMode){console.log(annos)};
			var errorsFound = false;
			for(var i=0; i < annos.length; i++){
				if(annos[i].type == "error"){
					errorsFound = true;
				}
			}
			if(errorsFound){
				validCode = false; 
			}else{
				validCode = true;
				if(settings.autoCompile){
					var cLen = editor.getValue().length;
					if(cLen != pLen){
						pLen = cLen;
						recompile();
					}
				}
			}
			if(settings.debugMode){console.log("validCode: " + validCode);}
		}

		window.onkeydown = function(event) {
			console.log(event);
			if(event.keyCode == 69 && event.ctrlKey){ // e = editor toggle
				editorToggle();
				event.preventDefault();
			}if(event.keyCode == 67 && event.ctrlKey){ // c = editor toggle
				cursorToggle();
				event.preventDefault();
			}else if(event.keyCode == 79 && event.ctrlKey){ // o = open
				switchSketch();
				event.preventDefault();
			}else if(event.keyCode == 77 && event.ctrlKey){ // m = menu
				menuToggle();
				event.preventDefault();
			}else if(event.keyCode == 70 && event.ctrlKey){ // f = fullscreen
				fullscreenToggle();
				event.preventDefault();
			}else if(event.keyCode == 13 && event.ctrlKey){ // enter = recompile
				recompile();
				event.preventDefault();
			}else if(event.keyCode == 80 && event.ctrlKey){ // p = pause
				pauseSketch();
				event.preventDefault();
			}else if(event.keyCode == 78 && event.ctrlKey){ // n = new
				loadDefault();
				event.preventDefault();
			}else if((event.keyCode >= 48 && event.keyCode <= 57) && event.ctrlKey && !event.shiftKey){ // 	0-9 = preset sketches
				var keySketch = event.keyCode - 49;
				if(keySketch == -1){keySketch = 9;}
				loadSketch(settings.sketches[keySketch]);
				event.preventDefault();
			}else if((event.keyCode >= 48 && event.keyCode <= 57) && event.ctrlKey && event.shiftKey){ // shift = TEST KEY
				var keySketch = event.keyCode - 48;
				addSnippet(keySketch);
				event.preventDefault();
			}else if(event.keyCode == 8){ // DELETE = prevent back navigation in FF
				var eTarget = event.target.tagName.toLowerCase();
				if(!p5code.focus() && eTarget != "input" && eTarget != "textarea"){
					event.preventDefault();
				}
			}else if(document.activeElement == menuNewSketch && event.keyCode == 13){ // ENTER, new sketch
				loadType();
				event.preventDefault();
			}
			//adjustLines();
		}

		// prevent lost work in default
		window.addEventListener("beforeunload", function (e) {
			if(settings.fileName == "default"){
				var confirmationMessage = "\o/";
				(e || window.event).returnValue = confirmationMessage; //Gecko + IE
				return confirmationMessage;                            //Webkit, Safari, Chrome
			}
		});


		/* COMPILE CODE */

		function recompile(){
			var currline = editor.getSelectionRange().start.row;
			var currCode = editor.session.getLine(currline);
			if(currCode.search("for") == -1 && currCode.search("while") == -1){
				if(validCode || !settings.strictCompile){
					p5frame.src = "p5live_sketch.html";
				}
			}
		}

		function loadScripts(elm){
			if(settings.debugMode){console.log(settings.scripts);}
			console.log(elm);
			for(var i=0; i < settings.scripts.length; i++){
				elm.appendChild(loadScript(settings.scripts[i]));
			}
		}

		function loadScript(scriptPath){
			var ps = document.createElement("script");
			ps.type = "text/javascript";
			ps.src = scriptPath;
			return ps;
		}

		function tidyCode(){
			var tempCode = js_beautify(editor.getValue(), beautifyOptions);
			editor.setValue(tempCode, 1);
		}



		/* SNIPPETS */
		function loadSnippets(){
			var snippetsPath = "includes/demos/P5L_snippets.json";
			var request = new XMLHttpRequest();
			request.open("GET", snippetsPath, false);
			request.send(null)
			var jsonObj = JSON.parse(request.responseText);
			snippets = jsonObj.snippets;
		}

		function addSnippet(loadSnippet){
			var snippetIndex = snippets.map(function(d) { return d['key']; }).indexOf(loadSnippet);
			if(snippetIndex == -1){
				return false;
			}
			var snippetCode = snippets[snippetIndex].code;
			var addGlobal = snippetCode.global;
			var addSetup = snippetCode.setup;
			var addDrawTop = snippetCode.draw.top;
			var addDrawBottom = snippetCode.draw.bottom;

			var curCode = editor.getValue();			
			var codeGlobal = addGlobal + "\n" + curCode;
			var codeSetup = addCode(codeGlobal, addSetup, "setup", "bottom");
			var codeDrawTop = addCode(codeSetup, addDrawTop, "draw", "top");
			var codeDrawBottom = addCode(codeDrawTop, addDrawBottom, "draw", "bottom");

			editor.setValue(codeDrawBottom, 1);
			tidyCode();
		}

		function addCode(codeBase, codeInsert, funName, codePos){
			var tempCode, tempPos = addPosition(codeBase, funName);
			if(codePos === "bottom"){
				tempCode = [codeBase.slice(0, tempPos[1]), "\n"+codeInsert+"\n", codeBase.slice(tempPos[1])].join('');
			}else if(codePos === "top"){
				tempCode = [codeBase.slice(0, tempPos[0]), codeInsert+"\n", codeBase.slice(tempPos[0])].join('');
			}
			return tempCode;
		}

		// grab start/end of function, modded for position only
		// https://stackoverflow.com/a/49240267/10885535
		function addPosition(content, functionName) {
		  // Find function
		  const indexOfFunc = content.indexOf(`function ${functionName}`);

		  if (indexOfFunc < 0) {
		    return content;
		  }

		  const openingBrace = content.indexOf('{', indexOfFunc);

		  const startPos = openingBrace + 1;
		  let endPos = startPos;
		  let bracesToBalance = 1;

		  while (true) {
		    if (content[endPos] === '{') {
		      bracesToBalance++;
		    } else if (content[endPos] === '}') {
		      bracesToBalance--;
		      if (bracesToBalance === 0) break;
		    }
		    endPos++;
		  }

		  return [startPos, endPos];
		};



		/* SETTINGS TOGGLES */

		// toggle auto-compile
		function autoCompileToggle(){
			settings.autoCompile = !settings.autoCompile;
			autoCompileUpdate();
		}

		function autoCompileUpdate(){
			checkToggle("autoCompile", settings.autoCompile, settingsAutoMode);
			if(settings.autoCompile){
				editor.setTheme("ace/theme/gob");
			}else{
				editor.setTheme(settings.theme);
			}
		}


		// toggle ecorender (pause if focus is lost)
		function ecoRenderToggle(){
			settings.ecoRender = !settings.ecoRender;
			ecoRenderUpdate();
		}

		function ecoRenderUpdate(){
			checkToggle("ecoRender", settings.ecoRender, settingsEcoMode);
		}


		// loop/noLoop on window blur
		window.onblur = function () { 
			if(settings.ecoRender && sketchLoaded){
				if(document.activeElement !== p5frame){
					p5f.noLoop();
				}
			}
		}
		window.onfocus = function () { 
			if(sketchLoaded){
				p5f.loop();
			}
		}


		// toggle fullscreen
		function fullscreenToggle(){
			settings.fullscreenMode = !settings.fullscreenMode;
			fullscreenUpdate();
		}

		function fullscreenUpdate(){
			checkToggle("fullscreenMode", settings.fullscreenMode, settingsFullscreen);
			if(settings.fullscreenMode){
				if(sketchLoaded){
					openFullscreen();
					editorToggleUpdate();
				}
			}else{
				if(sketchLoaded){
					closeFullscreen();
				}
			}
		}


		//cursor toggle
		function cursorToggle(){
			settings.canvasCursor = !settings.canvasCursor;
			cursorToggleUpdate();
		}

		function cursorToggleUpdate(){
			checkToggle("canvasCursor", settings.canvasCursor, settingsCanvasCursor);
			if(sketchLoaded){
				if(!settings.canvasCursor){
					p5f.noCursor();
					p5frameCover.style.cursor = "none";
				}else{
					p5f.cursor();
					p5frameCover.style.cursor = "crosshair";
				}
			}
		}


		//menutab toggle
		function menutabToggle(){
			settings.menutab = !settings.menutab;
			menutabToggleUpdate();
		}

		function menutabToggleUpdate(){
			checkToggle("menutab", settings.menutab, settingsMenutab);
			if(!settings.menutab){
				menuSwitch.style.display = "none";
			}else{
				menuSwitch.style.display = "block";
			}    	
		}


		// checkbox function
		function checkToggle(checkName, checkVar, checkElm){
			if(checkVar){
				checkElm.checked = true;
			}else{
				checkElm.checked = false;
			}
			settings[checkName] = checkVar;
			updateSettings();
			if(settings.debugMode){console.log(checkName+": "+settings[checkName]);}
		}


		// constant frameCount (great for recompiling)
		var fcTimer = setInterval(function(){
			if(sketchLoaded && p5f.frameCount != undefined){
				fc = p5f.frameCount;
			}
		}, 100);



		/* TOGGLE EDITOR + [canvas] + MENU */

		// hide/show editor
		function editorToggle(){
			if(p5editor.style.visibility != "visible"){
				p5editor.style.visibility = "visible";
			}else{
				p5editor.style.visibility = "hidden";
			}
			editorToggleUpdate();
		}

		function editorToggleUpdate(){
			if(p5editor.style.visibility != "visible"){
				const canv = document.querySelector('canvas');
				editor.blur();
			}else{
				editor.focus();
			}
		}

		// hide/show canvas
		// future usage for etherpad editing...
		
		/*
		function canvasToggle(){
			const canv = document.querySelector('canvas');
			//alert(canv);
			if(canv.style.visibility != "visible"){
				canv.style.visibility = "visible";
			}else{
				canv.style.visibility = "hidden";
			}
			canvasToggleUpdate();
		}

		function canvasToggleUpdate(){
			const canv = document.querySelector('canvas');
			if(canv.style.visibility != "visible"){
				if(sketchLoaded)
					noLoop();
			}else{
				if(sketchLoaded)
					loop();
			}
		}
		*/


		// hide/show menu
		function menuToggle(){
			settings.menuMode = !settings.menuMode;
			updateSettings();
			menuToggleUpdate();
		}

		function menuToggleUpdate(){
			if(!settings.menuMode){
				menuPanel.style.marginRight = "-250px";
				menuSwitch.innerHTML = "«";
			}else{
				menuPanel.style.marginRight = "0px";
				menuSwitch.innerHTML = "»";
			}
		}


		// load theme
		function loadTheme(){
			for(var i=0; i < menuTheme.options.length; i++){
				var opt = menuTheme.options[i];
				if(settings.theme == opt.value){
					menuTheme.selectedIndex = i;
				}
			}
		}

		// set theme
		function setTheme(sel){
			// var optgroup = menuTheme.options[sel].closest("optgroup").label;
			if(!settings.autoCompile){
				editor.setTheme(menuTheme.value);
			}
			settings.theme = menuTheme.value;
			updateSettings();
		}


		// load themeBG 
		function loadBG(){
			settingsBG.value = settings.themeBG;
			//menuBG.style.backgroundColor = "#" + settings.themeBG;

		}

		// set themeBG
		function setBG(val){
			if(settings.themeBG != val){
				settings.themeBG = val+"";
				updateSettings();
				editor.renderer.updateFull();
				//menuBG.style.backgroundColor = "#" + settings.themeBG;
				//styleMenu();
			}
		}

		// paused for launch.. to visit in future!
		function styleMenu(){
			// buttons
			setStyle("class", "menu-button", "backgroundColor", ColorLuminance(settings.themeBG, .4));
		}

		function setStyle(styleType, styleElm, styleAttribute, styleChange){
			var elms;
			if(styleType == "class"){
				elms = document.getElementsByClassName(styleElm);
			}else if(styleType == "tag"){
				elms = document.getElementsByTagName(styleElm);
			}else if(styleType == "id"){
				elms = document.getElementById(styleElm);
			}
			for(var i=0; i < elms.length; i++){
				elms[i].style[styleAttribute] = styleChange;
			}
		}

		// https://www.sitepoint.com/javascript-generate-lighter-darker-color/
		function ColorLuminance(hex, lum) {
			// validate hex string
			hex = String(hex).replace(/[^0-9a-f]/gi, '');
			if (hex.length < 6) {
				hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
			}
			lum = lum || 0;

			// convert to decimal and change luminosity
			var rgb = "#", c, i;
			for (i = 0; i < 3; i++) {
				c = parseInt(hex.substr(i*2,2), 16);
				c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
				rgb += ("00"+c).substr(c.length);
			}

			return rgb;
		}

		// adjust fontsize
		function fontSizeAdjust(newVal){
			settings.fontSize = newVal;
			updateSettings();
			fontSizeUpdate();
		}


		function fontSizeUpdate(){
			if(settingsFontsize !== document.activeElement){
				settingsFontsize.value = settings.fontSize;
			}
			p5code.style.fontSize = settings.fontSize + "pt";
		}



		/* LOAD VARIOUS SKETCHES */

		function loadDefault(){
			settings.fileName = 'default'; //editor.setValue("hi"); // p5template.value
			localStorage.setItem(settings.fileName, p5template);
			editor.setValue(p5template, 1);
			editor.gotoLine(7, 1, false);
			updateMenu();
			editor.focus();
			setTimeout(function(){ recompile(); }, 100);
		}

		function loadAbout(){
			settings.fileName = 'p5liveabout'; //editor.setValue("hi"); // p5template.value
			localStorage.setItem(settings.fileName, p5liveabout);
			editor.setValue(p5liveabout, 1);
			editor.focus();
			updateMenu();
			updateSettings();
			setTimeout(function(){ recompile(); }, 100);
		}

		function loadNew(newName){
			if(newName != ''){
				settings.fileName = newName;
				if (settings.sketches.indexOf(settings.fileName) === -1) {
					settings.sketches.unshift(settings.fileName);
					updateSketches();
						if(editor.getValue().length > 86){ // 86 = template length
							localStorage[settings.fileName] = editor.getValue();
						}else{
							editor.setValue(p5template, 1);
						}
				}else{
					editor.setValue(localStorage[settings.fileName], 1);
				}
				editor.focus(); 
				updateSettings();
			}
		}
			

		// create typed in sketch
		function loadType(){
			var fn = menuNewSketch.value.replace(/["']/g, "");
			if(fn == ''){
				fn = new Date().toISOString().replace(/-|:/g, "").replace("T", "_").split(".")[0];
			}
			loadNew(fn);
			document.title = 'P5LIVE - ' + settings.fileName;
			recompile();
		}


		/* PROMPT SKETCH SWITCHER */

		function switchSketch() {
			settings.fileName = prompt('P5LIVE\nbringing p5js into a live-coding environment!\n\nDefault Sketch:\nPress \'OK\'\n\nNew Sketch:\nType name and press \'OK\'\n\nOpen Sketch:\nType name of saved sketch and press \'OK\'\n\nSaved Sketches:\n' + settings.sketches, '').replace(/["']/g, "");
			if(settings.fileName == '') { 
				loadDefault();
			}else{
				loadNew(settings.fileName);
			}
			document.title = 'P5LIVE - ' + settings.fileName;
			updateMenu();
			recompile();
		};



		/* iFrame magic */

		// get mouse clicks on top
		// *** crazy magic, inspired from here:
		// https://stackoverflow.com/a/44143731/10885535
		window.addEventListener('mousemove', passMouse);
		window.addEventListener('mouseup', passMouseClick);
		window.addEventListener('mousedown', passMouseClick);
		
		var fields = ['pageX','pageY','screenX', 'screenY', 'clientX', 
		'clientY','ctrlKey', 'altKey', 'shiftKey', 'metaKey',
		'button', 'buttons', 'relatedTarget', 'region'];
		
		var pass = false;
		function passMouse(event){
			pass = !pass;
			if (pass) {
				var opts = {};
				fields.forEach(function(f) {
					if (f in event) {
						opts[f] = event[f];
					}
				});
				var copy = new MouseEvent(event.type, opts);
				p5f.dispatchEvent(copy);
			}
		};

		function passMouseClick(event){
			var opts = {};
			fields.forEach(function(f) {
				if (f in event) {
					opts[f] = event[f];
				}
			});
			var copy = new MouseEvent(event.type, opts);
			p5f.dispatchEvent(copy);  
		};


		// pass keys on down
		// tips: https://stackoverflow.com/questions/596481/
		window.addEventListener('keydown', function(ev) {
			sendKey(ev.type, ev, p5f);
		});

		window.addEventListener('keyup', function(ev) {
			sendKey(ev.type, ev, p5f);
		});

		function sendKey(type, ev, elm){
			var e = new Event(type); 
			e.key=ev.key; 
			e.keyCode=ev.keyCode; 
			e.which=ev.keyCode; 
			e.altKey=ev.altKey; 
			e.ctrlKey=ev.ctrlKey; 
			e.shiftKey=ev.shiftKey; 
			e.metaKey=ev.metaKey; 
			e.code=ev.code; 
			elm.dispatchEvent(e);
		}


		// pass sketch into p5frame
		// https://jaspreetchahal.org/how-to-inject-javascript-into-an-iframe/
		function injectJS() {
			sketchLoaded = false;
			var iFrameHead = p5f.document.getElementsByTagName("head")[0];
			// loadScripts(iFrameHead); // eventually dynamic script load
			var s = document.createElement("script");
			s.type = "text/javascript";
			s.innerHTML = editor.getValue() + p5custom.value + 'new p5(); sketchStatus();';
			iFrameHead.appendChild(s);
		}

		/* View in fullscreen */
		function openFullscreen() {
			var elem = document.body;
			if (elem.requestFullscreen) {
				elem.requestFullscreen();
			} else if (elem.mozRequestFullScreen) { /* Firefox */
				elem.mozRequestFullScreen();
			} else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
				elem.webkitRequestFullscreen();
			} else if (elem.msRequestFullscreen) { /* IE/Edge */
				elem.msRequestFullscreen();
			}
		}

		/* Close fullscreen */
		function closeFullscreen() {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.mozCancelFullScreen) { /* Firefox */
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
				document.webkitExitFullscreen();
			} else if (document.msExitFullscreen) { /* IE/Edge */
				document.msExitFullscreen();
			}
		}
	</script>
</body>
</html>