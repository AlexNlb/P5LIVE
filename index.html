<!DOCTYPE html>
<!-- <html manifest="cache.manifest"> -->
<head>
  <title>P5LIVE</title>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="P5LIVE">
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, minimal-ui">
  <style type="text/css">
    * {
      box-sizing: border-box;
    }
    ::selection {
      background-color: #fff;
    }
    html {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      font-family: 'Source Sans Pro', 'Open Sans', Roboto, 'Helvetica Neue', 'Segoe UI', 'Myriad Pro', Helvetica, Myriad, Arial, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      color: #839496;
      background: #000;
      position: relative;
      background:#000;
    }
    
    #editor,
    #preview, canvas {
      position:fixed;
      top:0;
      left:0;
      width: 100vw;
      height:100vh;
      margin: 0;
      outline: none;
      background: none;
      border: none;
      box-sizing: border-box;

    }
    #editor {
      transition: background-color .1s ease-in-out;
      font-family: 'Monaco','Source Code Pro', Menlo, Consolas, monospace;
      color: #fff;
      padding: 25px;
      font-size: 3vw;
      z-index:1;
      mix-blend-mode:difference;
      will-change: opacity;
      -webkit-font-smoothing: antialiased;
      /*display:block;*/
      visibility: visible;
      box-sizing: border-box;
    }
    #preview {
      background: #000;
      appearance: none;
      z-index:-1;
      -webkit-user-select: none; /* Chrome/Safari */        
      -moz-user-select: none; /* Firefox */
      -ms-user-select: none; /* IE10+ */
    }
    #preview:hover,
    #preview:focus {
      opacity: 1;
      cursor: default;
    }
    
    /* MENU */
    #menu{
    	font-family:"Monaco", sans-serif;
      position:fixed;
      top:0;
      right:0;
      margin-right:-250px;
      height:100vh;
      width:250px;
      box-sizing: border-box;
      padding:15px;
      color:#fff;
      z-index:101;
      transition: margin-right .4s linear;
      mix-blend-mode:difference;
    }
    #menu-switch{
    	position:absolute;
    	font-size:40px;
    	top:0;
    	left:-2.5vw;
    	height:100%;
    	cursor:pointer;
    	mix-blend-mode:difference;
    	color:#fff;
    	opacity:.05;
    	transition: opacity .5s linear;
    	z-index:1000;
    }
    #menu-switch:hover{
    	opacity:1;
    }
    #menu-bg{
    	position:absolute;
    	top:0;
    	left:0;
    	width:100%;
    	height:100%;
    	background:#333;
    	z-index:-1;
    	opacity: .5;

    }
    .menu-section{
    	margin:0 0 35px 0;
    }
    .menu-header{
      font-size:1.5vw;
      color:#fff;
      border-bottom:1px solid #fff;
      margin:0px 0 5px 0;
    }
    .menu-contents{
    	padding-left:5px;
    }
    #menu-sketches-holder{
      color:#fff;
      height:40vh;
      overflow:auto;
    }
    #menu-sketches-buttons{
    	padding-left:0px;
    	margin-bottom: 5px;
    	margin-top:-8px;
    	font-size:1vw;
    }
    #menu-sketches-buttons button{
    	color:#000;
    	background:#fff;
    	margin:0;
    	padding:0 2px;
    	border:1px solid #fff;
    	border-top:none;
    	outline:none;
    	cursor:pointer;
    }
    #menu-sketches-buttons button:hover{
    	background:#000;
    	color:#fff;
    }
    #menu-sketches{
      height:100%;
    }
    #menu-sketch-new{
    	outline:none;
    	border:none;
    	background:none;
    	color:#fff;
    	padding:0;
    	height:auto;
    	margin:0;
    }
    .menu-sketch-holder{
      margin:3px;
      padding:2px 4px;
      padding-left:10px;
      height:25px;
      cursor:pointer;
      font-size:1vw;
      overflow: hidden;
      box-sizing: border-box;
    }
    .menu-sketch-holder:hover{
    	background:#222;
    }
		.menu-sketch-holder:hover .menu-sketch-nav{
			display:block;
		}
    .menu-sketch{
      width: auto;
    	overflow: hidden;
    	float:none;
    }
    .menu-sketch:hover{
    }
    .sketch-selected{
      background:#444;
    }
    .sketch-selected .menu-sketch-nav{
    	display:block;
    }
    .menu-sketch-nav{
    	float:right;
    	width:50px;
    	display:none;
    	z-index:101;
    }
    .menu-sketch-button{
    	font-size:7pt;
    	height:100%;
    	color:#fff;
    	padding:3px 6px 3px 6px;
    }
    .menu-sketch-button:hover{
    	background:#555;
    }
    #menu-settings{
    }
    #menu-settings div{
      margin-bottom:10px;
    }
    #menu-settings-fontsize{
      width:2em;
      font-size:1.25vw;
      text-align:center;
      color:#fff;
      border:none;
      outline:none;
      background:none;
      border-bottom:2px solid #fff;
    }
    
    /* MOBILE */
    @media (max-width: 481px) {
     
    }
  </style>
    <script src="includes/p5/p5.min.js"></script>
    <script src="includes/p5/addons/p5.dom.min.js"></script>
    <script src="includes/p5/addons/p5.sound.min.js"></script>
    <script src="includes/p5/sketch.js"></script>
    <script src="includes/js/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="includes/js/src-min-noconflict/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    
</head>
<body>
  <div>
    <div id="preview"></div>
    <pre id="editor" autofocus></pre>
    <div id="holdscript"></div>
  </div>
  
  <div id="menu">
  	<div id="menu-bg"></div>
  	<div id="menu-switch" onclick="menuToggle();">X</div>
  	<div class="menu-section">
  		<div class="menu-header">P5LIVE</div>
  		<div class="menu-contents" onclick="loadAbout();" style="cursor:help;" title="click me to learn all about p5live">About</div>
  	</div>
  	<div class="menu-section">
      <div id="menu-sketches-header" class="menu-header">SKETCHES</div>
      	<div id="menu-sketches-buttons">
          <button onclick="loadDefault();">NEW</button>
          <button onclick="document.getElementById('file-input').click();">IMPORT</button>
					<input id="file-input" type="file" name="name" style="display: none;" onchange="sketchesImport(this.files[0]);" />
          <button onclick="document.getElementById('file-input-replace').click();">REPLACE</button>
					<input id="file-input-replace" type="file" name="name" style="display: none;" onchange="sketchesReplace(this.files[0]);" />
          <button onclick="sketchesExport();">EXPORT</button>
        </div>

        <div id="menu-sketches-new"></div>
      <div id="menu-sketches-holder" >
        <div id="menu-sketches"></div>
      </div>
    </div>
  	
    <div class="menu-section">
      <div id="menu-settings-header" class="menu-header">SETTINGS</div>
      <div id="menu-settings" class="menu-contents">
        <div>
          Font-Size: <input type="" name="menu-settings-fontsize" id="menu-settings-fontsize" value="2" onkeyup="fontSizeAdjust(this.value);"> vw
        </div>
        <div >
            <span style="cursor:help;" title="Prevents compiling unless strict Javascript is error free">Strict Compile:</span> 
            <input type="checkbox" id="settings-errormode" name="settings-errormode" value="settings-errormode" onchange="errorModeToggle();" >
        </div>
        <div>
            <span style="cursor:help;" title="Force new instance of P5JS on each compile">Instance Compile:</span> 
            <input type="checkbox" id="settings-hardcompile" name="settings-hardcompile" value="settings-hardcompile" onchange="hardCompileToggle();">
        </div>
        <div>
            <span style="cursor:help;" title="Compile code on each keypress">Auto Compile:</span> 
            <input type="checkbox" id="settings-automode" name="settings-automode" value="settings-automode" onchange="autoModeToggle();">
        </div>
         <div>
            <span style="cursor:help;" title="Toggle fullscreen mode">Fullscreen:</span> 
            <input type="checkbox" id="settings-fullscreen" name="settings-fullscreen" value="settings-fullscreen" onchange="fullscreenToggle();">
        </div>
        <div>
            <span style="cursor:help;" title="Only render if window is active (focused)">Eco Render:</span> 
            <input type="checkbox" id="settings-ecomode" name="settings-ecomode" value="settings-ecomode" onchange="ecoModeToggle();">
        </div>
      </div>
    </div>
    
  </div>
  <footer><a id="download" download="export.html"></a></footer>
  <textarea style="display:none;" id="p5-template">
function setup() {
	createCanvas(windowWidth, windowHeight);

}

function draw() {
	
}</textarea>
	<textarea style="display:none;" id="p5-resize">
function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}</textarea>
<textarea style="display:none;" id="p5live-about">
/*
P5LIVE v 1.0.1
cc teddavis.org 2019
bringing p5js into a live-coding environment!


THANKS
-------------------------------
p5.js » https://p5js.org (magic)
ace editor » https://ace.c9.io (editor)
tinkerpad » https://github.com/tomhodgins/tinkerpad (localstorage idea)


CMD-KEYS
-------------------------------
ctrl + enter » compile
ctrl + r » instance compile
ctrl + a » autocompile
ctrl + e » editor toggle
ctrl + f » fullscreen toggle
ctrl + m » menu toggle
ctrl + o » open sketch prompt
ctrl + - » decrease fontsize
ctrl + + » increase fontsize


TIPS
-------------------------------
- While livecoding, once done with setup(), turn off 'Instance Compile' 
  to keep frameCount clock running and smooth refreshes.
  
- Instance Compile is required if switching between WEBGL + 2D sketches,
  same for any major settings changes in p5js (rectMode, etc).
 

PLANS
-------------------------------
    - etherpad-like collaborative editing
    - mobile optomization
    - audio in
    - export image [video?]
    

SOURCE
-------------------------------
github » *github link*


*/

function setup() {
	createCanvas(windowWidth, windowHeight);
    rectMode(CENTER);
    noCursor();
    noStroke();

}

function draw() {
	var lc = 12;
	for(var i=0; i < lc; i++){
	    var x = map(i, 0, lc-1, width/2, mouseX);
	    var y = map(i, 0, lc-1, height/2, mouseY);
	    var s = map(i, 0, lc-1, width, width/lc);
	    var fc = abs(sin((frameCount*i)*0.001))*155;
	    push();
	    translate(x, y);
	    var rs = sin(frameCount*i*0.0005)*15;
	    rotate(radians(rs));
	    fill(100+fc);
	    rect(0, 0, s, s);
	    pop();
	}
}</textarea>
  <script type="text/javascript">
    /*
      TODO
      - cleanup un-necessary css/html
      - reimplement manifest for offline use?
      - FB/share details
      - split css/js or single page = benefit?
      - 
    */



    /* INIT THINGS */

    // init localStorage
    var reset = false;

    if(reset){
      localStorage.removeItem("sketches");
      localStorage.removeItem("settings");
    }
    if(localStorage.getItem("sketches") == null){
       localStorage.setItem("sketches", "default");
    }
    if(localStorage.getItem("settings") == null){
        localStorage.setItem("settings", JSON.stringify({"fontSize":3, "editColor":"rgb(255, 255, 255)", "autoColor":"rgb(100, 255, 100)", "autoMode":false, "hardCompile":true}));
    }

    // init vars
    var editorPane = document.getElementById('editor'),
        previewPane = document.getElementById('preview'),
        p5template = document.getElementById('p5-template').value,
        p5liveabout = document.getElementById('p5live-about').value,
        p5resize = document.getElementById('p5-resize').value,
        p5script = document.getElementById("holdscript"),
        menuSketches = document.getElementById('menu-sketches'),
        menuSettings = document.getElementById('menu-settings'),
        settingsErrorMode = document.getElementById('settings-errormode'),
        settingsAutoMode = document.getElementById('settings-automode'),
        settingsEcoMode = document.getElementById('settings-ecomode'),
        settingsFullscreen = document.getElementById('settings-fullscreen'),
        settingsHardCompile = document.getElementById('settings-hardcompile'),
        settingsFontsize = document.getElementById('menu-settings-fontsize'),
        menuNewSketch = document.getElementById('menu-sketch-new'),
        menuPanel = document.getElementById('menu'),
        menuSwitch = document.getElementById('menu-switch'),
        menuMode = true, //*temp
        fileName = '',
        sketches = getSketches(", "),
        settings = getSettings(),
        errorMode = settings.errorMode, 
        autoMode = settings.autoMode, 
        fullscreenMode = false,
        validCode = true, 
        hardCompile = settings.hardCompile,
        debugMode = true,
        sketchLoaded = false,
        ecoMode = settings.ecoMode,
        pLen = 0, 
        p5;
       
		// init editor 
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/twilight");
    editor.session.setMode("ace/mode/javascript");
    editor.setOptions({
    	showPrintMargin: false,
    	animatedScroll: false,
    	displayIndentGuides: false,
    	useWorker: false, // investigate
    	showLineNumbers: false,
    	showGutter: false,
    });

    editorPane.style.visibility = "visible";



    /* FANCY EDITOR FUNCTIONS */

   	// compile if no errors (** still needed??)
    editor.session.on('changeMode', function(e, session){
      if ("ace/mode/javascript" === session.getMode().$id) {
        if (!!session.$worker) {
          session.$worker.send("changeOptions", [{
            asi: true,
          }]);
        }
      }
    });

    // prevent compile if bad code
    editor.getSession().on("changeAnnotation", function(){
      var annot = editor.getSession().getAnnotations();
      if(annot.length == 0){
        validCode = true;
      }else{
        validCode = false;
      }
    });

    // CMD-KEYS (remove key conflicts)
    editor.commands.removeCommands(["gotoright","movelinesup", "movelinesdown", "gotolinestart", "splitline", "gotolineend"]);

   // replace backspace w/o ctrl + h
   editor.commands.addCommand({
    name: "backspace",
    bindKey: { win: "Shift-Backspace|Backspace", mac: "Ctrl-Backspace|Shift-Backspace|Backspace" },
    exec: function(e) { e.remove("left") },
    multiSelectAction: "forEach",
    scrollIntoView: "cursor"
   });

   //replace gotoright w/o ctrl + f
   editor.commands.addCommand({
    name: "gotoright",
    bindKey: { win: "Right", mac: "Right" },
    exec: function(e,t) { e.navigateRight(t.times) },
    multiSelectAction: "forEach",
    scrollIntoView: "cursor",
    readOnly:!0
   });



   /* DEBUG EDITOR COMMANDS + STORAGE */

   // list ace editor commands
   function listCommands(){
   	var cmds = editor.commands.commands;
   	var k = [];
   	for (var cmd in cmds){
   		k.push(cmd.name +" = "+ cmd.bindKey);
   	}
   	console.log(cmds);
   }

   // check storageKeys    
    function getKeys(){
      var k = [];
      for (var key in localStorage){
         k.push(key);
      }
      console.log(k.join(", "));
    }

		if(debugMode){
			listCommands();
			getKeys();
		}

  

    /* SETTINGS + SKETCHES */

  	// init settings
    loadSettings();

    // get settings from localstorage
    function getSettings(){
      return JSON.parse(localStorage.getItem('settings'));
    }

    // react to settings once gathered
    function loadSettings(){
    	// load fontSize
			editorPane.style.fontSize = settings.fontSize+"vw";
    	
    	// load toggles
			hardCompileUpdate();
    	errorModeUpdate();
    	autoModeUpdate();
    	fullscreenUpdate();
    	menuToggleUpdate();
    	ecoModeUpdate();
    }

    // set settings to localstorage
    function updateSettings(){
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    // set sketches list to localstorage
    function updateSketches(){
      localStorage.setItem("sketches", sketches.join(", ")); 
      updateMenu();
    }

    // get sketches list from localstorage
    function getSketches(splitter){
      var sketchesSplit = localStorage.getItem("sketches").split(splitter);
      return sketchesSplit.filter(Boolean);
    }

    // load sketch
    function loadSketch(sketch){
      fileName = sketch;
      editor.setValue(localStorage[fileName], 1);
      updateMenu();
      updateP5(hardCompile);
      editor.focus();
    }

    // rename sketch
    function renameSketch(sketch){
    	var newName = prompt('Please enter a new name for "'+sketch+'":');
    	if(newName != ''){
    		localStorage.setItem(newName, localStorage[sketch]);
    		var index = sketches.indexOf(sketch);
				if (index !== -1) {
				    sketches[index] = newName;
				}
    		localStorage.removeItem(sketch);
    		updateSketches();
    		setTimeout(function(){ loadSketch(newName); }, 100);
    	}
    }

    // remove sketch
    function removeSketch(sketch){
	    var doubleCheck = confirm("Are you sure you want to delete: " +sketch+" ?");
	      if(doubleCheck){
	        localStorage.removeItem(sketch);
	        var index = sketches.indexOf(sketch);    // <-- Not supported in <IE9
	        if (index !== -1) {
	            sketches.splice(index, 1);
	        }
	        if(sketch === fileName){
	        	setTimeout(function(){ loadDefault(); }, 100);
	        }
	        updateSketches();
	      }
    }



    /* IMPORT/EXPORT SKETCHES */

    // export single sketch to JSON
    function exportSketch(sketch){
    	var jsonExport = {};
    	jsonExport.sketches = [];
    	jsonExport.sketches.push({"sketchName":sketch, "sketchCode":localStorage.getItem(sketch)});
      var dateStamp = (new Date()).toISOString().replace(/[^0-9]/g, "").slice(0, -3);
      saveJSON(jsonExport, 'P5L_'+sketch+'_'+dateStamp+'.json');
      if(debugMode)
      	console.log(jsonExport);
    }

    // export all sketches to JSON
    function sketchesExport(){
    	var jsonExport = {};
    	jsonExport.sketches = [];
    	for(var i=0; i < sketches.length; i++){
    		jsonExport.sketches.push({"sketchName":sketches[i], "sketchCode":localStorage.getItem(sketches[i])});
      }
      jsonExport.settings = settings;
      var dateStamp = (new Date()).toISOString().replace(/[^0-9]/g, "").slice(0, -3);
      saveJSON(jsonExport, 'P5L_sketches_'+dateStamp+'.json');
      if(debugMode)
      	console.log(jsonExport);
    }

    // import sketches from JSON
    function sketchesImport(data){
    	var reader = new FileReader();
			reader.onload = function(data) {
		    var jsonObj = JSON.parse(event.target.result);
		    for(var i=0; i < jsonObj.sketches.length; i++){
		    	var sketchName = jsonObj.sketches[i].sketchName;
		    	var sketchCode = jsonObj.sketches[i].sketchCode;
		    	localStorage.setItem(sketchName, sketchCode);
		    	if (sketches.indexOf(sketchName) === -1) {
	          sketches.unshift(sketchName);
	        }
	        if(sketchName == fileName){
	        	loadSketch(sketchName);
	        }
		    }
		    updateSketches();
		  }
		  reader.readAsText(data);
    }

    // import + replace all sketches from JSON
    function sketchesReplace(data){
    	var doubleCheck = confirm("Are you sure you want to replace ALL skeches?");
    	if(doubleCheck){
	    	localStorage.removeItem("sketches");
	    	sketches = [];
	    	sketchesImport(data);
    	}
    }



    /* LIST SKETCHES IN MENU */

    function updateMenu(){
      var sketchesSplit = localStorage.getItem("sketches").split(', ');
      var menuSketchesHTML = '';
      var selSelected = false;
      for(var i=0; i < sketchesSplit.length; i++){
        var selClass = "";
        if(sketchesSplit[i] == fileName){
          selClass = 'sketch-selected';
          selSelected = true;
        }
        menuSketchesHTML += '<div class="menu-sketch-holder '+selClass+'"><div class="menu-sketch-nav"><a class="menu-sketch-button" onclick="renameSketch(\''+sketchesSplit[i]+'\')" title="Rename Sketch">id</a><a class="menu-sketch-button" onclick="exportSketch(\''+sketchesSplit[i]+'\')" title="Export Sketch">↓</a><a class="menu-sketch-button" onclick="removeSketch(\''+sketchesSplit[i]+'\')" title="Remove Sketch">x</a></div><div class="menu-sketch" onclick="loadSketch(\''+sketchesSplit[i]+'\')">'+sketchesSplit[i]+'</div></div>';
      }
      var selClass = "";
      if(!selSelected){
      	selClass = 'sketch-selected';
      }
      var menuSketchesNew = '<div class="menu-sketch-holder '+selClass+'"><input type="" name="menu-sketch-new" id="menu-sketch-new" class="menu-sketch-holder" placeholder="Save Sketch As..." onkeydown="loadType(this);"></div>';
      menuSketches.innerHTML = menuSketchesHTML;
      document.getElementById('menu-sketches-new').innerHTML = menuSketchesNew;
			menuNewSketch = document.getElementById('menu-sketch-new');
    }



		/* EDITOR KEY-CMDS */

    // Editor Interactions
    onload = editorPane.onkeyup = function() {
      //console.log(Object.keys(localStorage));
      if(fileName == ''){ 
      	loadDefault();
      };
      if(autoMode){
      	// only refresh if new content typed
      	var cLen = editor.getValue().length;
      	console.log(cLen +" / "+ pLen);
      	if(cLen != pLen){
      		pLen = cLen;
      		refreshView();
      	}
      }
      localStorage[fileName] = editor.getValue();
    };
   
    editorPane.onkeydown = function(event) {
    	// check length of editor
    	pLen = editor.getValue().length;

    	if(debugMode)
      		console.log(event);
      if((event.key == '+' || event.key == '=' )&& event.ctrlKey){ // up arrow = bigger font
        fontSizeAdjust(parseFloat(settings.fontSize) + 0.25);
        event.preventDefault();
      }else if((event.key == '-') && event.ctrlKey){ // down arrow = smaller font
        fontSizeAdjust(parseFloat(settings.fontSize) - 0.25);
        event.preventDefault();
      }else if(event.keyCode == 65 && event.ctrlKey){ // a = auto compile
        autoModeToggle();
        event.preventDefault();
      }
    }

     window.onkeydown = function(event) {
      if(event.keyCode == 69 && event.ctrlKey){ // e = editor toggle
        editorToggle();
        event.preventDefault();
      }else if(event.keyCode == 79 && event.ctrlKey){ // o = open
        switchSketch();
        event.preventDefault();
      }else if(event.keyCode == 77 && event.ctrlKey){ // m = menu
        menuToggle();
        event.preventDefault();
      }else if(event.keyCode == 70 && event.ctrlKey){ // f = fullscreen
        fullscreenToggle();
        event.preventDefault();
      }else if(event.keyCode == 82 && event.ctrlKey){ // r = reset compile
        updateP5(true);
        editorPane.focus();
        event.preventDefault();
      }else if(event.keyCode == 13 && event.ctrlKey){ // enter = recompile
        refreshView();
        event.preventDefault();
      }
    }


    /* COMPILE CODE */

    // compile + focus
    function refreshView() {
      updateP5(hardCompile);
      editorPane.focus();
    }

    // compile latest editor code
    function updateP5(compileMode){
      if(validCode || !errorMode){
      	sketchLoaded = false;
        p5script.innerHTML = "";
        
        if(compileMode){
	        p5RemoveHack();
	        var ps = document.createElement("script");
	        ps.type = "text/javascript";
	        ps.src = "includes/p5/p5.min.js";
	        p5script.appendChild(ps);
	        
	        var ps2 = document.createElement("script");
	        ps.type = "text/javascript";
	        ps.src = "includes/p5/addons/p5.dom.min.js";
	        p5script.appendChild(ps2);
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.innerHTML = editor.getValue();
        s.innerHTML += p5resize;
        p5script.appendChild(s);

        if(!hardCompile)
        	setup();
        sketchLoaded = true;
      }
    }

    // hack to completely refresh global-instance p5js
    // GoToLoop » https://codepen.io/GoSubRoutine/pen/ZBPjdP
    function p5RemoveHack() {
      if (window.p5 && p5.instance) {
        p5.instance.remove();
        p5.instance = window.setup = window.draw = null;
      } else {
        const canv = document.querySelector('canvas');
        canv && canv.remove();
      }
    }


    /* SETTINGS TOGGLES */

    // toggle strict javascript for compiling
    function errorModeToggle(){
    	errorMode = !errorMode;
      errorModeUpdate();
    }

    function errorModeUpdate(){
    	checkToggle("errorMode", errorMode, settingsErrorMode);
    	if(errorMode){
              //editor.session.setOption("showGutter", true);
              editor.renderer.setShowGutter(true); 
              editor.session.setOption("useWorker", true);
        }else{
              //editor.session.setOption("showGutter", false);
              //editor.renderer.setShowGutter(true); 
              editor.renderer.setShowGutter(false);
              editor.session.setOption("useWorker", false);
      }
    }


    // toggle auto-compile
    function autoModeToggle(){
    	autoMode = !autoMode;
   		autoModeUpdate();
    }

    function autoModeUpdate(){
    	checkToggle("autoMode", autoMode, settingsAutoMode);
      if(autoMode){
      	editor.setTheme("ace/theme/gob");
      }else{
      	editor.setTheme("ace/theme/twilight");
      }
    }


    // toggle ecomode (pause if focus is lost)
		function ecoModeToggle(){
    	ecoMode = !ecoMode;
   		ecoModeUpdate();
    }

    function ecoModeUpdate(){
    	checkToggle("ecoMode", ecoMode, settingsEcoMode);
    }

    // loop/noLoop on window blur
    window.onblur = function () { 
    	if(ecoMode && sketchLoaded){
    		noLoop(); 
    	}
    }
		window.onfocus = function () { 
			if(sketchLoaded){
				loop(); 
			}
		}


    // toggle fullscreen
    function fullscreenToggle(){
	    fullscreenMode = !fullscreenMode;
			fullscreenUpdate();
    }

    function fullscreenUpdate(){
    	checkToggle("fullscreenMode", fullscreenMode, settingsFullscreen);
      if(fullscreenMode){
        const canv = document.querySelector('canvas');
        canv.style.top = 0;
        if(sketchLoaded)
        	fullscreen(true);
        editorToggleUpdate();
      }else{
      	if(sketchLoaded)
        	fullscreen(false);
      }
    }


    // create new instance of p5js on compile
    function hardCompileToggle(){
    	hardCompile = !hardCompile;
    	hardCompileUpdate();
    }

    function hardCompileUpdate(){
    	checkToggle("hardCompile", hardCompile, settingsHardCompile);
    }


    // checkbox function
    function checkToggle(checkName, checkVar, checkElm){
    	//checkVar = !checkVar;
    	if(checkVar){
				checkElm.checked = true;
    	}else{
				checkElm.checked = false;
    	}
    	settings[checkName] = checkVar;
    	updateSettings();
    	if(debugMode){
				console.log(checkName+": "+checkVar);
    	}
    }



    /* TOGGLE EDITOR + [canvas] + MENU */

    // hide/show editor
    function editorToggle(){
    	if(editorPane.style.visibility != "visible"){
        editorPane.style.visibility = "visible";
      }else{
        editorPane.style.visibility = "hidden";
      }
      editorToggleUpdate();
    }

    function editorToggleUpdate(){
      if(editorPane.style.visibility != "visible"){
        editor.focus();
      }else{
        const canv = document.querySelector('canvas');
        canv.focus();
      }
    }

    // hide/show canvas
    /*
    // future usage for etherpad editing...

    function canvasToggle(){
    	const canv = document.querySelector('canvas');
    	//alert(canv);
    	if(canv.style.visibility != "visible"){
        canv.style.visibility = "visible";
      }else{
        canv.style.visibility = "hidden";
      }
      canvasToggleUpdate();
    }

    function canvasToggleUpdate(){
    	const canv = document.querySelector('canvas');
			if(canv.style.visibility != "visible"){
        if(sketchLoaded)
        	noLoop();
      }else{
        if(sketchLoaded)
        	loop();
      }
    }
    */

    // hide/show menu
    function menuToggle(){
      menuMode = !menuMode;
      menuToggleUpdate();
    }

    function menuToggleUpdate(){
    	if(!menuMode){
        menuPanel.style.marginRight = "-250px";
        menuSwitch.innerHTML = "☰";
      }else{
        menuPanel.style.marginRight = "0px";
        menuSwitch.innerHTML = "x";
      }
    }

    // adjust fontsize
    function fontSizeAdjust(newVal){
      settings.fontSize = newVal;
      updateSettings();
      fontSizeUpdate();
    }

    function fontSizeUpdate(){
    	if(settingsFontsize !== document.activeElement)
      	settingsFontsize.value = settings.fontSize;
			editorPane.style.fontSize = settings.fontSize + "vw";
    }



		/* LOAD VARIOUS SKETCHES */


    function loadDefault(){
    		fileName = 'default'; //editor.setValue("hi"); // p5template.value
        localStorage.setItem(fileName, p5template);
        editor.setValue(p5template, 1);
        editor.gotoLine(7, 1, false);
        editor.focus();
        updateMenu();
        setTimeout(function(){ updateP5(hardCompile); }, 100);
    }

    function loadAbout(){
    	fileName = 'p5liveabout'; //editor.setValue("hi"); // p5template.value
      localStorage.setItem(fileName, p5liveabout);
      editor.setValue(p5liveabout, 1);
      editor.gotoLine(7, 1, false);
      editor.focus();
      updateMenu();
      setTimeout(function(){ updateP5(hardCompile); }, 100);
    }

    function loadNew(newName){
    	fileName = newName;
    	if(localStorage[fileName] != ''){ 
	        if (sketches.indexOf(fileName) === -1) {
	          sketches.unshift(fileName);
	          updateSketches();
	          if(editor.getValue().length > 86){ // 86 = template length
			         localStorage[fileName] = editor.getValue();
			      }else{
			      	editor.setValue(p5template, 1);
			      }
	        }else{
	          editor.setValue(localStorage[fileName], 1);
	        }
	        editor.focus(); 
	      }
    }

    // create typed in sketch
    function loadType(){
    	if(event.keyCode === 13) {
    		var fn = menuNewSketch.value;
    		loadNew(fn);
    		document.title = 'P5LIVE - ' + fileName;
        refreshView();
        event.preventDefault();
    	}
    }


    /* PROMPT SKETCH SWITCHER */

    function switchSketch() {
      fileName = prompt('P5LIVE\nbringing p5js into a live-coding environment!\n\nDefault Sketch:\nPress \'OK\'\n\nNew Sketch:\nType name and press \'OK\'\n\nOpen Sketch:\nType name of saved sketch and press \'OK\'\n\nSaved Sketches:\n' + getSketches(",  "), '');
      if(fileName == '') { 
        loadDefault();
      }else{
	      loadNew(fileName);
    	}

      document.title = 'P5LIVE - ' + fileName;
      refreshView();
      updateMenu();
    };

  </script>
</body>
</html>